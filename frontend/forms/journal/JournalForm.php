<?php

namespace frontend\forms\journal;

use common\helpers\files\FilePaths;
use common\helpers\html\HtmlBuilder;
use common\helpers\StringFormatter;
use common\Model;
use common\repositories\educational\GroupProjectThemesRepository;
use common\repositories\educational\TrainingGroupLessonRepository;
use common\repositories\educational\TrainingGroupRepository;
use common\repositories\educational\VisitRepository;
use DomainException;
use frontend\models\work\dictionaries\ForeignEventParticipantsWork;
use frontend\models\work\dictionaries\PersonInterface;
use frontend\models\work\educational\journal\ParticipantLessons;
use frontend\models\work\educational\journal\VisitLesson;
use frontend\models\work\educational\journal\VisitWork;
use frontend\models\work\educational\training_group\GroupProjectThemesWork;
use frontend\models\work\educational\training_group\TrainingGroupWork;
use Yii;
use yii\helpers\Url;
use yii\log\LogRuntimeException;

/**
 * @property TrainingGroupWork $trainingGroupWork
 */

class JournalForm extends Model
{
    /** @var VisitWork[] $visits */
    public array $visits;
    public $groupId;
    public $trainingGroup;

    /** @var ParticipantLessons[] $participantLessons */
    public array $participantLessons = [];

    /** @var GroupProjectThemesWork[] $availableThemes */
    public array $availableThemes;

    public function rules()
    {
        return [
            ['participantLessons', 'safe']
        ];
    }

    public function __construct(
        int $groupId = null,
        $config = []
    )
    {
        parent::__construct($config);
        if (!is_null($groupId)) {
            $this->groupId = $groupId;
            $this->trainingGroup = (Yii::createObject(TrainingGroupRepository::class))->get($this->groupId);
            $this->visits = (Yii::createObject(VisitRepository::class))->getByTrainingGroup($this->groupId);
            $this->availableThemes = (Yii::createObject(GroupProjectThemesRepository::class))->getProjectThemesFromGroup($this->groupId);

            foreach ($this->visits as $visit) {
                /** @var VisitWork $visit */
                $lessons = VisitLesson::fromString($visit->lessons, Yii::createObject(TrainingGroupLessonRepository::class));
                $this->participantLessons[] = new ParticipantLessons(
                    $visit->training_group_participant_id,
                    $lessons,
                    $visit->trainingGroupParticipantWork->group_project_themes_id,
                    $visit->trainingGroupParticipantWork->points,
                    $visit->trainingGroupParticipantWork->success
                );
            }
        }

        foreach ($this->participantLessons as $participantLesson) {
            $participantLesson->sortLessons();
        }
    }

    public function load($data, $formName = null)
    {
        // Дозагружаем VisitLesson и доп данные для ParticipantLessons вручную, ActiveRecord не справляется сам
        $newParticipantLessons = [];
        $visitLessons = $data["VisitLesson"];
        $participantData = $data["ParticipantLessons"];

        if (is_array($visitLessons) && is_array($participantData)) {
            if (count($visitLessons) !== count($participantData)) {
                throw new DomainException('Техническая ошибка сервера. Закройте страницу и попробуйте еще раз');
            }

            foreach ($visitLessons as $index => $visitLesson) {
                $lessonArray = [];
                foreach ($visitLesson as $lesson) {
                    $lessonArray[] = new VisitLesson(
                        $lesson["lessonId"],
                        $lesson["status"],
                        (Yii::createObject(TrainingGroupLessonRepository::class))->get($lesson["lessonId"])
                    );
                }

                $groupProjectThemeId = !empty($participantData[$index]['groupProjectThemeId']) ?
                    (int)$participantData[$index]['groupProjectThemeId'] :
                    null;
                $newParticipantLessons[] = new ParticipantLessons(
                    $index,
                    $lessonArray,
                    $groupProjectThemeId,
                    (int)$participantData[$index]['points'],
                    (int)$participantData[$index]['successFinishing']
                );
            }
            $this->participantLessons = $newParticipantLessons;
        }
        return parent::load($data, $formName); // TODO: Change the autogenerated stub
    }

    /**
     * Возвращает номер учебной группы
     * @return mixed|string|null
     */
    public function getTrainingGroupNumber()
    {
        return $this->trainingGroup ? $this->trainingGroup->number : '';
    }

    /**
     * Иконка архивного статуса
     * @return string
     */
    public function getRawArchiveGroup()
    {
        return $this->trainingGroup ? $this->trainingGroup->getRawArchive() : '';
    }

    /**
     * Список занятий в расписании
     * @return array|int
     */
    public function getDateLessons()
    {
        if (count($this->participantLessons) > 0) {
            return $this->participantLessons[0]->getLessonsDate();
        }
        return 1;
    }

    /**
     * Количество занятий
     * @return int
     */
    public function getLessonsCount()
    {
        if (count($this->participantLessons) > 0) {
            return $this->participantLessons[0]->getLessonsCount();
        }
        return 1;
    }

    /**
     * Красивое отображение успешного завершения
     * @param int $status
     * @return false|string
     */
    public function getPrettySuccessFinishing(int $status)
    {
        if ($status == 1) {
            return file_get_contents(FilePaths::SVG_CHECK);
        }
        return file_get_contents(FilePaths::SVG_CROSS);
    }

    public function getPrettyParticipant(ForeignEventParticipantsWork $participant)
    {
        $partLink = StringFormatter::stringAsLink($participant->getFIO(PersonInterface::FIO_SURNAME_INITIALS),
            Url::to([Yii::$app->frontUrls::PARTICIPANT_VIEW, 'id' => $participant->id]));
        return HtmlBuilder::createTooltip(
            $partLink,
            $participant->getFIO(PersonInterface::FIO_FULL));
    }
}